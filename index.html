// JavaScript Code
let gameState = {
    pairs: [],
    englishWords: [],
    swedishWords: [],
    selectedCards: [],
    correctMatches: 0,
    incorrectMatches: 0,
    timeLeft: 120,
    timerId: null,
    stats: new Map()
};

// Input Screen Elements
const inputScreen = document.getElementById('inputScreen');
const wordInput = document.getElementById('wordInput');
const startGameBtn = document.getElementById('startGame');
const timeDisplay = document.getElementById('timeDisplay');

// Game Screen Elements
const gameScreen = document.getElementById('gameScreen');
const englishColumn = document.getElementById('englishColumn');
const swedishColumn = document.getElementById('swedishColumn');
const gameTimer = document.getElementById('gameTimer');

// Results Screen Elements
const resultsScreen = document.getElementById('resultsScreen');

// Timer Controls
document.getElementById('increaseTime').addEventListener('click', () => adjustTime(1));
document.getElementById('decreaseTime').addEventListener('click', () => adjustTime(-1));

// Game Controls
document.getElementById('backButton').addEventListener('click', showInputScreen);
document.getElementById('finishButton').addEventListener('click', endGame);
document.getElementById('replayButton').addEventListener('click', startGame);
document.getElementById('newWordsButton').addEventListener('click', showInputScreen);

// Input Validation
wordInput.addEventListener('input', () => {
    startGameBtn.disabled = !wordInput.value.trim();
});

// Start Game
startGameBtn.addEventListener('click', startGame);

function adjustTime(change) {
    let [minutes, seconds] = timeDisplay.textContent.match(/\d+/g).map(Number);
    let totalSeconds = minutes * 60 + seconds + change * 30;
    
    totalSeconds = Math.max(30, Math.min(totalSeconds, 600));
    
    const newMinutes = Math.floor(totalSeconds / 60);
    const newSeconds = totalSeconds % 60;
    timeDisplay.textContent = `⏳ ${String(newMinutes).padStart(1, '0')}:${String(newSeconds).padStart(2, '0')}`;
    gameState.timeLeft = totalSeconds;
}

function startGame() {
    if (!parseInput()) return;
    
    inputScreen.classList.remove('active');
    gameScreen.classList.add('active');
    resultsScreen.classList.remove('active');
    
    gameState.selectedCards = [];
    gameState.correctMatches = 0;
    gameState.incorrectMatches = 0;
    
    initializeGameBoard();
    startTimer();
}

function parseInput() {
    const lines = wordInput.value.trim().split('\n');
    gameState.pairs = [];
    gameState.stats.clear();

    for (const line of lines) {
        const [english, swedish] = line.split(',').map(s => s.trim());
        if (english && swedish) {
            gameState.pairs.push({ english, swedish });
            gameState.stats.set(english, { correct: 0, incorrect: 0 });
        }
    }
    
    if (gameState.pairs.length < 6) {
        alert('Please enter at least 6 word pairs');
        return false;
    }
    
    return true;
}

function initializeGameBoard() {
    englishColumn.innerHTML = '';
    swedishColumn.innerHTML = '';
    
    const shuffledPairs = [...gameState.pairs].sort(() => Math.random() - 0.5);
    gameState.englishWords = shuffledPairs.slice(0, 6).map(p => p.english);
    gameState.swedishWords = shuffledPairs.slice(0, 6).map(p => p.swedish).sort(() => Math.random() - 0.5);

    gameState.englishWords.forEach(word => createCard(word, 'english'));
    gameState.swedishWords.forEach(word => createCard(word, 'swedish'));
}

function createCard(word, language) {
    const column = language === 'english' ? englishColumn : swedishColumn;
    const card = document.createElement('div');
    card.className = 'card';
    card.textContent = word;
    
    card.addEventListener('click', () => handleCardClick(card, language));
    column.appendChild(card);
}

function handleCardClick(card, language) {
    if (card.classList.contains('selected')) {
        card.classList.remove('selected');
        gameState.selectedCards = gameState.selectedCards.filter(c => c !== card);
    } else {
        if (gameState.selectedCards.length === 2) return;
        card.classList.add('selected');
        gameState.selectedCards.push({ card, language });
    }

    if (gameState.selectedCards.length === 2) {
        checkMatch();
    }
}

function checkMatch() {
    const [first, second] = gameState.selectedCards;
    const englishWord = first.language === 'english' ? first.card.textContent : second.card.textContent;
    const swedishWord = first.language === 'swedish' ? first.card.textContent : second.card.textContent;
    
    const pair = gameState.pairs.find(p => p.english === englishWord && p.swedish === swedishWord);
    
    if (pair) {
        handleCorrectMatch(first.card, second.card, pair.english);
    } else {
        handleIncorrectMatch(first.card, second.card);
    }
}

function handleCorrectMatch(card1, card2, englishWord) {
    card1.classList.add('correct');
    card2.classList.add('correct');
    
    const stats = gameState.stats.get(englishWord);
    stats.correct++;
    gameState.correctMatches++;
    
    setTimeout(() => {
        card1.remove();
        card2.remove();
        refillColumns();
    }, 1000);
    
    gameState.selectedCards = [];
}

function handleIncorrectMatch(card1, card2) {
    card1.classList.add('incorrect');
    card2.classList.add('incorrect');
    
    const englishWord = [card1, card2].find(c => c.parentElement === englishColumn).textContent;
    const stats = gameState.stats.get(englishWord);
    stats.incorrect++;
    gameState.incorrectMatches++;
    
    setTimeout(() => {
        card1.classList.remove('selected', 'incorrect');
        card2.classList.remove('selected', 'incorrect');
        gameState.selectedCards = [];
    }, 1000);
}

function refillColumns() {
    setTimeout(() => {
        const missingEnglish = 6 - englishColumn.children.length;
        const missingSwedish = 6 - swedishColumn.children.length;
        
        const newPairs = [...gameState.pairs]
            .filter(p => !gameState.englishWords.includes(p.english))
            .sort(() => Math.random() - 0.5)
            .slice(0, Math.max(missingEnglish, missingSwedish));
        
        newPairs.forEach(pair => {
            if (englishColumn.children.length < 6) {
                createCard(pair.english, 'english');
                gameState.englishWords.push(pair.english);
            }
            if (swedishColumn.children.length < 6) {
                createCard(pair.swedish, 'swedish');
                gameState.swedishWords.push(pair.swedish);
            }
        });
    }, 500);
}

function startTimer() {
    let timeLeft = gameState.timeLeft;
    gameState.timerId = setInterval(() => {
        timeLeft--;
        gameTimer.textContent = `⏳ ${String(Math.floor(timeLeft / 60)).padStart(2, '0')}:${String(timeLeft % 60).padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            endGame();
        }
    }, 1000);
}

function endGame() {
    clearInterval(gameState.timerId);
    gameScreen.classList.remove('active');
    resultsScreen.classList.add('active');
    
    document.getElementById('totalCorrect').textContent = gameState.correctMatches;
    document.getElementById('totalIncorrect').textContent = gameState.incorrectMatches;
    
    const tbody = document.querySelector('#resultsTable tbody');
    tbody.innerHTML = '';
    
    gameState.stats.forEach((stats, englishWord) => {
        const pair = gameState.pairs.find(p => p.english === englishWord);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${englishWord}</td>
            <td>${pair.swedish}</td>
            <td style="color: darkgreen">${stats.correct}</td>
            <td style="color: red">${stats.incorrect}</td>
        `;
        tbody.appendChild(row);
    });
}

function showInputScreen() {
    inputScreen.classList.add('active');
    gameScreen.classList.remove('active');
    resultsScreen.classList.remove('active');
    clearInterval(gameState.timerId);
}